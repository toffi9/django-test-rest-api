version: 0.2

env:
  variables:
  # TODO: installing newest version of docker-compose always
  - DOCKER_COMPOSE_VERSION=1.16.1

phases:

  install:
    commands:
      # Installing newest docker-ce
      - curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo apt-key add -
      - sudo add-apt-repository "deb [arch=amd64] https://download.docker.com/linux/ubuntu $(lsb_release -cs) stable"
      - sudo apt-get update
      - sudo apt-get -y install docker-ce
      - docker -v
      # Installing docker-compose
      - sudo rm /usr/local/bin/docker-compose
      - curl -L https://github.com/docker/compose/releases/download/${DOCKER_COMPOSE_VERSION}/docker-compose-`uname -s`-`uname -m` > docker-compose
      - chmod +x docker-compose
      - sudo mv docker-compose /usr/local/bin
      - docker-compose -v

  pre_build:
    commands:
      - docker-compose -f dev.yml build

  build:
    commands:
      # linting whole project (api, tests)
      - docker-compose -f dev.yml run --rm django flake8
      # unit tests
      - docker-compose -f dev.yml run --rm django pytest -vv

  # TODO: pushing to ECR when master or develop is ok
  # after_success:
  #   - if [ "$TRAVIS_BRANCH" == "master" ]; then
  #     docker login -u="$DOCKER_USERNAME" -p="$DOCKER_PASSWORD";
  #     docker push USER/REPO;
  #     fi
